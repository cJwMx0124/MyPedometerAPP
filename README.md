# 实时速度计步器 (V3 - 基于加速度传感器)

该项目是一个为安卓平台开发的实时速度计步器应用。它通过直接分析加速度传感器的数据来提供灵敏、平滑的实时步行/跑步速度估算。

与传统的、使用计步器传感器（`TYPE_STEP_COUNTER`）的计步器相比，本应用的核心优势在于其**低延迟**和**高响应性**。

---

## 核心功能模块

1.  **实时速度估算**：应用的核心，使用加速度传感器数据实时计算用户的瞬时移动速度。
2.  **个人化步长**：允许用户输入身高，应用会根据 `步长 ≈ 身高 * 0.45` 的公式估算个人步长，以提高速度计算的准确性。
3.  **平滑速度显示**：内置指数移动平均（EMA）滤波器，对计算出的、有剧烈跳变的瞬时速度进行平滑处理，提供稳定、易读的视觉体验。
4.  **速度上限告警**：
    *   用户可自定义速度上限（单位：米/秒）。
    *   当平滑后的速度超过此上限时，系统会触发告警。
    *   告警模式为周期性提醒（默认为每5秒一次），而非持续骚扰。
5.  **自动停止检测**：当用户停止运动后，应用能自动检测并平滑地将速度降至零。
6.  **极简UI**：隐藏了非核心的步数显示，专注于速度的呈现。

---

## 技术实现与关键算法

-   **传感器**：采用 `Sensor.TYPE_ACCELEROMETER`，并以 `SensorManager.SENSOR_DELAY_GAME` 的较高频率进行数据采样，以保证数据的实时性。

-   **计步算法**：
    1.  通过一个高通滤波器（High-pass Filter）基本上去除静态的重力影响。
    2.  计算线性加速度向量的模（Magnitude），以忽略手机朝向的影响。
    3.  通过一个简单的峰值检测算法，在加速度的模超过特定阈值（`stepThreshold`）时识别为有效步伐。

-   **速度计算**：
    -   **瞬时速度**：`瞬时速度 = 个人步长 / (当前步时间 - 上一步时间)`
    -   **平滑速度**：`新平滑速度 = (瞬时速度 * α) + (旧平滑速度 * (1-α))`，其中 `α` 是平滑因子 `SMOOTHING_ALPHA`。

-   **告警逻辑**：通过一个时间戳 `lastAlertTimeMs` 实现。只有当 `(当前时间 - 上次告警时间) > 告警间隔` 时，才会再次触发告警，避免了频繁打扰。

---

## 核心调优参数

在 `MainActivity.kt` 文件中，有几个核心参数可供未来进行微调，以优化不同设备或用户习惯下的体验：

-   `stepThreshold` (Float): **步数检测阈值**。
    -   **作用**：判断多大的加速度冲击才算一步。
    -   **调整**：如果走路时步数识别不灵敏，可**降低**此值（如 `1.8f`）；如果轻微晃动也被计为步数，可**提高**此值（如 `2.5f`）。

-   `SMOOTHING_ALPHA` (Float): **EMA平滑因子**。
    -   **作用**：控制速度显示的平滑程度，取值在0到1之间。
    -   **调整**：值越**小**，速度显示越**平滑**，但对真实速度变化的响应越慢（如 `0.1f`）；值越**大**，响应越**快**，但可能保留部分抖动（如 `0.3f`）。

-   `ALERT_INTERVAL_MS` (Long): **告警时间间隔**。
    -   **作用**：定义了在持续超速状态下，每隔多久重复提醒一次，单位为毫秒。
    -   **调整**：可根据需要修改此值，例如 `3000L` (3秒) 或 `10000L` (10秒)。